# üîê Strat√©gie d'Authentification et Backend
## La Manufacture de la Porte

---

## üìã Vue d'ensemble

Ce document d√©finit la strat√©gie pour impl√©menter un syst√®me d'authentification complet avec backend pour s√©curiser l'acc√®s au configurateur de porte.

### üéØ Objectifs
- Contr√¥ler l'acc√®s au configurateur de porte
- G√©rer les comptes utilisateurs (clients, partenaires, admin)
- Sauvegarder les configurations personnalis√©es
- Tra√ßabilit√© des commandes et devis

---

## üèóÔ∏è Architecture Propos√©e

### Frontend (React/TypeScript)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Page de Login     ‚îÇ ‚Üê Point d'entr√©e obligatoire
‚îÇ   (/login)          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ
          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Page d'Accueil    ‚îÇ ‚Üê Accessible apr√®s auth
‚îÇ   (/)               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ
          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Configurateur     ‚îÇ ‚Üê Prot√©g√© par auth
‚îÇ   (/config)         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Backend Options

#### Option 1: Firebase (Recommand√©e)
**Avantages :**
- ‚úÖ Authentification int√©gr√©e (email/password, Google, etc.)
- ‚úÖ Base de donn√©es Firestore en temps r√©el
- ‚úÖ H√©bergement inclus
- ‚úÖ S√©curit√© enterprise
- ‚úÖ Pas de serveur √† maintenir

**Services utilis√©s :**
- **Firebase Auth** : Gestion des comptes
- **Firestore** : Stockage des configurations
- **Firebase Hosting** : D√©ploiement (alternative √† Netlify)
- **Cloud Functions** : API pour logique m√©tier

#### Option 2: Backend Node.js + PostgreSQL
**Avantages :**
- ‚úÖ Contr√¥le total
- ‚úÖ Base de donn√©es relationnelle
- ‚úÖ API REST personnalis√©e

**Stack technique :**
- **Express.js** : Serveur API
- **PostgreSQL** : Base de donn√©es
- **JWT** : Tokens d'authentification
- **bcrypt** : Hashage des mots de passe
- **Vercel/Railway** : H√©bergement backend

---

## üîê Syst√®me d'Authentification

### Types d'Utilisateurs

#### 1. **Clients** (Particuliers)
- Acc√®s au configurateur
- Sauvegarde de leurs projets
- Historique des configurations
- Demande de devis

#### 2. **Partenaires** (Professionnels)
- Acc√®s privil√©gi√© au configurateur
- Gestion de plusieurs projets clients
- Tarifs pr√©f√©rentiels
- Export en lots

#### 3. **Administrateurs**
- Gestion des utilisateurs
- Analytics et statistiques
- Gestion du catalogue produits
- Validation des commandes

### Flux d'Authentification

```mermaid
graph TD
    A[Visiteur] --> B{Authentifi√©?}
    B -->|Non| C[Page Login]
    B -->|Oui| D[Page Accueil]
    
    C --> E{Type de connexion}
    E -->|Email/Password| F[Formulaire Login]
    E -->|Google OAuth| G[OAuth Google]
    E -->|Inscription| H[Formulaire Inscription]
    
    F --> I{Credentials valides?}
    G --> I
    H --> J[Validation email]
    
    I -->|Oui| K[Token JWT]
    I -->|Non| L[Erreur]
    J --> M[Compte activ√©]
    
    K --> D
    M --> D
    L --> C
    
    D --> N[Configurateur Prot√©g√©]
```

---

## üìä Base de Donn√©es

### Structure Firestore (Option 1)

#### Collection `users`
```javascript
{
  uid: "user123",
  email: "client@example.com",
  displayName: "Jean Dupont",
  role: "client", // client | partner | admin
  company: "Entreprise XYZ", // optionnel pour partenaires
  createdAt: timestamp,
  lastLogin: timestamp,
  isActive: true
}
```

#### Collection `configurations`
```javascript
{
  id: "config123",
  userId: "user123",
  name: "Porte Salon",
  svgData: "...", // SVG modifi√©
  parameters: {
    OUVERTURE_L: "902",
    PORTE_L: "816",
    PASSAGE_L: "790",
    CLOISON_E: "74",
    // ...
  },
  createdAt: timestamp,
  updatedAt: timestamp,
  isPublic: false
}
```

#### Collection `projects` (pour partenaires)
```javascript
{
  id: "project123",
  partnerId: "user456",
  clientName: "M. Martin",
  clientEmail: "martin@example.com",
  configurations: ["config123", "config456"],
  status: "draft", // draft | quoted | ordered | completed
  quotedPrice: 1250.00,
  notes: "Porte sur mesure pour salon",
  createdAt: timestamp
}
```

### Structure PostgreSQL (Option 2)

```sql
-- Table utilisateurs
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  display_name VARCHAR(255),
  role VARCHAR(50) DEFAULT 'client',
  company VARCHAR(255),
  created_at TIMESTAMP DEFAULT NOW(),
  last_login TIMESTAMP,
  is_active BOOLEAN DEFAULT true
);

-- Table configurations
CREATE TABLE configurations (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),
  name VARCHAR(255) NOT NULL,
  svg_data TEXT,
  parameters JSONB,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  is_public BOOLEAN DEFAULT false
);

-- Table projets (pour partenaires)
CREATE TABLE projects (
  id SERIAL PRIMARY KEY,
  partner_id INTEGER REFERENCES users(id),
  client_name VARCHAR(255),
  client_email VARCHAR(255),
  status VARCHAR(50) DEFAULT 'draft',
  quoted_price DECIMAL(10,2),
  notes TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

## üîß Impl√©mentation Frontend

### 1. Contexte d'Authentification

```typescript
// src/contexts/AuthContext.tsx
interface User {
  uid: string
  email: string
  displayName: string
  role: 'client' | 'partner' | 'admin'
  company?: string
}

interface AuthContextType {
  user: User | null
  loading: boolean
  login: (email: string, password: string) => Promise<void>
  logout: () => Promise<void>
  register: (email: string, password: string, displayName: string) => Promise<void>
}
```

### 2. Hook d'Authentification

```typescript
// src/hooks/useAuth.ts
export function useAuth() {
  const context = useContext(AuthContext)
  if (!context) {
    throw new Error('useAuth must be used within AuthProvider')
  }
  return context
}
```

### 3. Composant de Protection de Route

```typescript
// src/components/ProtectedRoute.tsx
interface ProtectedRouteProps {
  children: React.ReactNode
  requiredRole?: 'client' | 'partner' | 'admin'
}

export function ProtectedRoute({ children, requiredRole }: ProtectedRouteProps) {
  const { user, loading } = useAuth()
  
  if (loading) return <LoadingSpinner />
  if (!user) return <Navigate to="/login" />
  if (requiredRole && user.role !== requiredRole) return <AccessDenied />
  
  return <>{children}</>
}
```

### 4. Pages d'Authentification

```typescript
// src/pages/LoginPage.tsx
- Formulaire email/password
- Lien "Mot de passe oubli√©"
- Lien "Cr√©er un compte"
- OAuth Google (optionnel)

// src/pages/RegisterPage.tsx
- Formulaire d'inscription
- S√©lection du type de compte (client/partenaire)
- Validation email
```

---

## üé® Design de la Page de Login

### Style Gaming/Moderne
- **Fond sombre** coh√©rent avec le design actuel
- **Accents dor√©s** (laiton #DAA520) pour les boutons
- **Animations subtiles** au survol
- **Logo centr√©** en haut
- **Formulaire √©l√©gant** avec validation en temps r√©el

### √âl√©ments visuels
- Texture granuleuse sur les boutons (coh√©rent avec la m√©moire design)
- Effets de glow/lueur sur les √©l√©ments interactifs
- Transitions fluides
- Responsive design

---

## üîÑ Flux Utilisateur Complet

### 1. Premi√®re Visite
```
Visiteur ‚Üí Page Login ‚Üí Inscription ‚Üí Validation Email ‚Üí Page Accueil ‚Üí Configurateur
```

### 2. Utilisateur Existant
```
Visiteur ‚Üí Page Login ‚Üí Authentification ‚Üí Page Accueil ‚Üí Configurateur
```

### 3. Session Active
```
Visiteur ‚Üí (Token valide) ‚Üí Page Accueil ‚Üí Configurateur
```

---

## üíæ Fonctionnalit√©s Backend

### API Endpoints (Firebase Functions ou Express)

#### Authentification
- `POST /api/auth/login` - Connexion
- `POST /api/auth/register` - Inscription
- `POST /api/auth/logout` - D√©connexion
- `POST /api/auth/refresh` - Renouvellement token
- `POST /api/auth/forgot-password` - Mot de passe oubli√©

#### Configurations
- `GET /api/configurations` - Liste des configs utilisateur
- `POST /api/configurations` - Sauvegarder une config
- `PUT /api/configurations/:id` - Modifier une config
- `DELETE /api/configurations/:id` - Supprimer une config
- `GET /api/configurations/:id/share` - Partager une config

#### Projets (Partenaires)
- `GET /api/projects` - Liste des projets
- `POST /api/projects` - Cr√©er un projet
- `PUT /api/projects/:id` - Modifier un projet
- `POST /api/projects/:id/quote` - G√©n√©rer un devis

---

## üõ°Ô∏è S√©curit√©

### Mesures de S√©curit√©
- **HTTPS obligatoire** en production
- **Tokens JWT** avec expiration (24h)
- **Rate limiting** sur les endpoints sensibles
- **Validation c√¥t√© serveur** de tous les inputs
- **CORS configur√©** correctement
- **Sanitisation** des donn√©es SVG upload√©es

### Variables d'Environnement
```env
# Firebase
VITE_FIREBASE_API_KEY=...
VITE_FIREBASE_AUTH_DOMAIN=...
VITE_FIREBASE_PROJECT_ID=...

# ou Backend custom
VITE_API_BASE_URL=https://api.manufacture-porte.com
JWT_SECRET=...
DATABASE_URL=...
```

---

## üìÖ Plan de D√©veloppement

### Phase 1: Foundation (Semaine 1)
- [ ] Configuration Firebase ou setup backend
- [ ] Impl√©mentation du contexte d'authentification
- [ ] Cr√©ation de la page de login
- [ ] Protection des routes

### Phase 2: Fonctionnalit√©s Core (Semaine 2)
- [ ] Page d'inscription
- [ ] Gestion des sessions
- [ ] Sauvegarde des configurations
- [ ] Interface utilisateur

### Phase 3: Fonctionnalit√©s Avanc√©es (Semaine 3)
- [ ] Gestion des r√¥les (client/partenaire/admin)
- [ ] Syst√®me de projets pour partenaires
- [ ] Export et partage de configurations
- [ ] Dashboard administrateur

### Phase 4: Optimisation (Semaine 4)
- [ ] Performance et cache
- [ ] Tests automatis√©s
- [ ] Documentation utilisateur
- [ ] D√©ploiement production

---

## üöÄ Recommandation

**Option choisie : Backend Node.js + PostgreSQL** 

### Avantages pour votre projet :

1. **üéõÔ∏è Contr√¥le total** : Logique m√©tier personnalis√©e
2. **üíæ Base de donn√©es relationnelle** : Parfait pour les relations complexes (users/projects/configs)
3. **üîß Flexibilit√©** : √âvolution facile selon vos besoins sp√©cifiques
4. **üí∞ Co√ªts ma√Ætris√©s** : Pas de d√©pendance aux tarifs externes
5. **üè† Ind√©pendance** : Votre infrastructure, vos r√®gles
6. **üìä Analytics avanc√©s** : Contr√¥le total des donn√©es m√©tier

---

## üèóÔ∏è Architecture Backend D√©taill√©e

### Stack Technique Recommand√©e

#### Backend
- **Node.js 20+** : Runtime JavaScript
- **Express.js** : Framework web rapide et minimaliste
- **TypeScript** : Typage statique pour la robustesse
- **PostgreSQL 15+** : Base de donn√©es relationnelle performante
- **Prisma ORM** : ORM moderne avec migrations automatiques
- **JWT** : Authentification stateless
- **bcrypt** : Hashage s√©curis√© des mots de passe
- **Joi/Zod** : Validation des donn√©es
- **Winston** : Logging professionnel

#### H√©bergement
- **Railway.app** : H√©bergement backend simple (recommand√©)
- **Vercel** : Alternative pour API serverless
- **DigitalOcean** : VPS pour plus de contr√¥le
- **Neon.tech** : PostgreSQL manag√© gratuit

### Structure du Projet Backend

```
backend/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ controllers/          # Logique des routes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.controller.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.controller.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ project.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ middleware/           # Middlewares
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.middleware.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validation.middleware.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ rateLimit.middleware.ts
‚îÇ   ‚îú‚îÄ‚îÄ models/              # Mod√®les Prisma
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ schema.prisma
‚îÇ   ‚îú‚îÄ‚îÄ routes/              # D√©finition des routes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.routes.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.routes.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ project.routes.ts
‚îÇ   ‚îú‚îÄ‚îÄ services/            # Logique m√©tier
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.service.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.service.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ email.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ utils/               # Utilitaires
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ jwt.utils.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ password.utils.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ validation.utils.ts
‚îÇ   ‚îú‚îÄ‚îÄ config/              # Configuration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ env.ts
‚îÇ   ‚îî‚îÄ‚îÄ app.ts               # Point d'entr√©e
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îú‚îÄ‚îÄ migrations/          # Migrations DB
‚îÇ   ‚îî‚îÄ‚îÄ schema.prisma        # Sch√©ma de base
‚îú‚îÄ‚îÄ tests/                   # Tests automatis√©s
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ tsconfig.json
‚îî‚îÄ‚îÄ .env.example
```

### Sch√©ma de Base de Donn√©es Optimis√©

```sql
-- Utilisateurs avec r√¥les
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  display_name VARCHAR(255) NOT NULL,
  role user_role DEFAULT 'client',
  company VARCHAR(255),
  phone VARCHAR(50),
  address TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  last_login TIMESTAMP,
  is_active BOOLEAN DEFAULT true,
  email_verified BOOLEAN DEFAULT false,
  verification_token VARCHAR(255)
);

-- Enum pour les r√¥les
CREATE TYPE user_role AS ENUM ('client', 'partner', 'admin');

-- Sessions pour s√©curit√© renforc√©e
CREATE TABLE user_sessions (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
  token_hash VARCHAR(255) NOT NULL,
  expires_at TIMESTAMP NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  ip_address INET,
  user_agent TEXT
);

-- Configurations sauvegard√©es
CREATE TABLE configurations (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  svg_original TEXT, -- SVG d'origine
  svg_modified TEXT, -- SVG avec modifications
  parameters JSONB NOT NULL, -- Param√®tres de cotation
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  is_public BOOLEAN DEFAULT false,
  is_template BOOLEAN DEFAULT false,
  tags TEXT[] -- Pour recherche et cat√©gorisation
);

-- Projets (pour partenaires)
CREATE TABLE projects (
  id SERIAL PRIMARY KEY,
  partner_id INTEGER REFERENCES users(id),
  client_name VARCHAR(255) NOT NULL,
  client_email VARCHAR(255),
  client_phone VARCHAR(50),
  client_address TEXT,
  project_name VARCHAR(255) NOT NULL,
  description TEXT,
  status project_status DEFAULT 'draft',
  quoted_price DECIMAL(10,2),
  final_price DECIMAL(10,2),
  notes TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  deadline DATE
);

CREATE TYPE project_status AS ENUM ('draft', 'quoted', 'approved', 'in_production', 'completed', 'cancelled');

-- Relation projets <-> configurations
CREATE TABLE project_configurations (
  id SERIAL PRIMARY KEY,
  project_id INTEGER REFERENCES projects(id) ON DELETE CASCADE,
  configuration_id INTEGER REFERENCES configurations(id) ON DELETE CASCADE,
  quantity INTEGER DEFAULT 1,
  unit_price DECIMAL(10,2),
  notes TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Logs d'activit√© pour audit
CREATE TABLE activity_logs (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),
  action VARCHAR(100) NOT NULL,
  resource_type VARCHAR(50), -- 'configuration', 'project', etc.
  resource_id INTEGER,
  details JSONB,
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Index pour performance
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_sessions_token ON user_sessions(token_hash);
CREATE INDEX idx_configs_user ON configurations(user_id);
CREATE INDEX idx_projects_partner ON projects(partner_id);
CREATE INDEX idx_activity_user ON activity_logs(user_id);
CREATE INDEX idx_activity_created ON activity_logs(created_at);
```

### API Endpoints D√©taill√©s

#### üîê Authentification
```typescript
POST /api/auth/register
Body: { email, password, displayName, role?, company? }
Response: { user, token }

POST /api/auth/login  
Body: { email, password }
Response: { user, token }

POST /api/auth/logout
Headers: Authorization: Bearer <token>
Response: { success: true }

POST /api/auth/refresh
Headers: Authorization: Bearer <token>
Response: { token }

POST /api/auth/forgot-password
Body: { email }
Response: { message }

POST /api/auth/reset-password
Body: { token, newPassword }
Response: { success: true }
```

#### ‚öôÔ∏è Configurations
```typescript
GET /api/configurations
Headers: Authorization: Bearer <token>
Query: ?page=1&limit=10&search=porte&tags=salon
Response: { configurations[], total, page }

POST /api/configurations
Body: { name, description?, svgOriginal, svgModified, parameters, tags? }
Response: { configuration }

PUT /api/configurations/:id
Body: { name?, description?, svgModified?, parameters?, tags? }
Response: { configuration }

DELETE /api/configurations/:id
Response: { success: true }

GET /api/configurations/:id/share
Response: { publicUrl, expiresAt }
```

#### üè¢ Projets (Partenaires)
```typescript
GET /api/projects
Query: ?status=draft&client=martin
Response: { projects[], total }

POST /api/projects
Body: { clientName, clientEmail?, projectName, description? }
Response: { project }

PUT /api/projects/:id
Body: { status?, quotedPrice?, notes?, deadline? }
Response: { project }

POST /api/projects/:id/configurations
Body: { configurationId, quantity?, unitPrice? }
Response: { projectConfiguration }

GET /api/projects/:id/quote
Response: { quoteData, totalPrice, pdf? }
```

### S√©curit√© Renforc√©e

#### Middleware d'Authentification
```typescript
// V√©rification JWT sur toutes les routes prot√©g√©es
const authMiddleware = (req, res, next) => {
  const token = req.headers.authorization?.split(' ')[1]
  if (!token) return res.status(401).json({ error: 'Token manquant' })
  
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET)
    req.user = decoded
    next()
  } catch (error) {
    return res.status(401).json({ error: 'Token invalide' })
  }
}
```

#### Rate Limiting
```typescript
// Protection contre les attaques par force brute
const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 5, // 5 tentatives max
  message: 'Trop de tentatives de connexion'
})
```

### Prochaine √©tape
D√©velopper le backend Node.js/Express avec PostgreSQL et cr√©er l'API d'authentification.

---

*Document cr√©√© le 17 ao√ªt 2025*
*Version 1.1 - Backend personnalis√©*
